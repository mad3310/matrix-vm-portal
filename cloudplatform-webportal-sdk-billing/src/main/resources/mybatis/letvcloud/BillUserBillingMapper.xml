<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.letv.portal.dao.letvcloud.BillUserBillingMapper" >

  <select id="getUserBillings"  resultType="com.letv.portal.model.letvcloud.BillUserBilling">
    select
    billingId,orderId,billingMonth,billingMoney,userId,serviceCode,createdTime
    from
    bill_user_billing
    where userId = #{userId} and billingMonth = #{billingMonth}
    order by createdTime desc
  </select>
  <select id="getUserBillingDetails" resultType="com.letv.portal.letvcloud.bill.vo.BillMonthDetailBilling">
    SELECT tmp.featherCode,r.price,d.discount,tmp.totalFee,tmp.totalAmount FROM (SELECT t.featherCode,SUM(t.fee) AS totalFee,SUM(t.useAmount) AS totalAmount,t.orderId
    FROM bill_deduction_record t WHERE  t.deductionDate LIKE #{month}"%" AND t.orderId=#{orderId} GROUP BY t.featherCode) tmp
    LEFT JOIN bill_service_order_detail d ON tmp.orderId= d.orderId LEFT JOIN bill_fee_rule r ON
    d.feeCodeNow=r.feeCode
  </select>
    <select id="getUserBillingYears" resultType="string">
      SELECT SUBSTRING(t.billingMonth,1,4) AS billYear
      FROM bill_user_billing t
      WHERE userId = #{userId}
      GROUP BY SUBSTRING(t.billingMonth,1,4)
      ORDER BY SUBSTRING(t.billingMonth,1,4)  DESC
  </select>
  <insert id="insert" parameterType="com.letv.portal.model.letvcloud.BillUserBilling">
      insert into bill_user_billing(
        billingId,
        orderId,
        billingMonth,
        billingMoney,
        userId,
        serviceCode,
        createdTime
      )values(
        #{billingId},
        #{orderId},
        #{billingMonth},
        #{billingMoney},
        #{userId},
        #{serviceCode},
        now()
      )
    </insert>
    
</mapper>